# 飞书配置详细步骤指南

## 服务地址

**Vercel 部署地址**: `https://xero-feishu-bridge.vercel.app`

**飞书回调地址**: `https://xero-feishu-bridge.vercel.app/feishu`

---

## 步骤 1: 登录飞书开放平台

1. 打开浏览器，访问: https://open.feishu.cn/
2. 使用企业管理员账号登录
3. 进入开发者后台

---

## 步骤 2: 找到应用

1. 在左侧菜单点击 **"应用开发"**
2. 找到应用: **cli_a9139fddafb89bb5** (Xero Invoice Bot)
3. 点击进入应用详情页

---

## 步骤 3: 配置事件订阅

### 3.1 进入事件订阅页面

1. 在应用详情页左侧菜单，点击 **"事件订阅"**
2. 您会看到 **"请求地址配置"** 区域

### 3.2 设置请求地址

1. 找到 **"请求地址"** 输入框
2. 输入以下地址:
   ```
   https://xero-feishu-bridge.vercel.app/feishu
   ```
3. 点击 **"保存"** 或 **"验证"**

### 3.3 启用消息事件

1. 在 **"事件订阅"** 页面，找到 **"添加事件"** 按钮
2. 点击添加事件
3. 搜索并选择: **`im.message.receive_v1`**
   - 这是"接收消息"事件
4. 点击 **"确定"** 或 **"保存"**

---

## 步骤 4: 配置权限

### 4.1 进入权限管理

1. 在左侧菜单点击 **"权限管理"**
2. 找到 **"权限配置"** 标签

### 4.2 添加必要权限

确保以下权限已开启:

| 权限 | 说明 |
|------|------|
| `im:chat:readonly` | 获取群组信息 |
| `im:message:send` | 发送消息 |
| `im:message.group_msg` | 接收群消息 |

如果没有，点击 **"添加权限"** 搜索并添加。

---

## 步骤 5: 发布应用

### 5.1 进入版本管理与发布

1. 在左侧菜单点击 **"版本管理与发布"**
2. 点击 **"创建版本"**

### 5.2 填写版本信息

- **版本号**: 1.0.0
- **更新说明**: Xero 开票机器人
- **可见范围**: 选择需要使用的部门或全员

### 5.3 保存并发布

1. 点击 **"保存"**
2. 点击 **"申请发布"**
3. 等待管理员审批（如果是自己开发，直接通过）

---

## 步骤 6: 将机器人加入群聊

### 6.1 打开飞书群

1. 在飞书客户端，打开需要使用机器人的群聊
2. 点击右上角的 **"..."** 或 **群设置**

### 6.2 添加群机器人

1. 找到 **"群机器人"** 选项
2. 点击 **"添加机器人"**
3. 在列表中找到: **Xero Invoice Bot** (cli_a9139fddafb89bb5)
4. 点击 **"添加"**

---

## 步骤 7: 测试

在群聊中发送测试消息:

```
开票 ABC abc@email.com 2
```

### 预期结果

机器人会回复:
```
开票完成：INV-000X 邮件状态:204
```

---

## 故障排查

### 问题 1: 飞书显示"请求地址验证失败"

**原因**: Vercel 服务可能需要唤醒

**解决**:
1. 在浏览器访问: https://xero-feishu-bridge.vercel.app/
2. 等待页面显示 `{"status":"running"...}`
3. 返回飞书重新验证

### 问题 2: 机器人没有反应

**检查清单**:
- [ ] 事件订阅地址是否正确
- [ ] `im.message.receive_v1` 事件是否已启用
- [ ] 机器人是否已添加到群聊
- [ ] 应用是否已发布
- [ ] 权限是否正确配置

### 问题 3: 开票失败

**检查**:
- 客户邮箱格式是否正确
- 数量是否为数字
- Xero API 是否正常运行

---

## 配置完成后的架构

```
用户飞书消息
    ↓
飞书服务器
    ↓
Vercel 服务 (https://xero-feishu-bridge.vercel.app)
    ↓
Xero API
    ↓
创建发票 + 发送邮件
    ↓
飞书 API 回复
    ↓
用户看到结果
```

---

## 需要帮助？

如果配置过程中遇到问题，请告诉我:
1. 具体在哪一步卡住
2. 显示什么错误信息
3. 我可以帮您进一步排查
